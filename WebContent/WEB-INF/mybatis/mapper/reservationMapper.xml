<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reservation">
	<insert id="insertReservation" parameterType="com.pet.reservation.Reservation">
		INSERT INTO reservation(reservationNum, checkIn, checkOut, pet_type, pet_su, num, hostNum)
		VALUES (reservation_seq.NEXTVAL, #{checkIn}, #{checkOut}, #{pet_type}, #{pet_su}, #{num}, #{hostNum})	
	</insert>
	
	<sql id="where-list">
		<if test="searchKey=='userName'">
			userName=#{searchValue}
		</if>
		<if test="searchKey=='wait'">
			accept=#{searchValue}
		</if>
		<if test="searchKey=='accept'">
			accept=#{searchValue}
		</if>			
	</sql>
	
	<!-- 글 개수 -->
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(reservationNum), 0) FROM reservation r
			JOIN member m ON r.num=m.num
		<where>
	     	<if test="searchValue!=null and searchValue!='' ">
	     	    <include refid="where-list"/>
	     	</if>
	     	AND (r.num=#{num})
	     </where>   
	</select>
	
	<!-- 글리스트 -->
	<select id="listReservation" parameterType="map" resultType="com.pet.reservation.Reservation">
		SELECT * FROM (
			SELECT ROWNUM rnum, tb.* FROM (
				SELECT reservationNum, r.num, r.hostNum, accept, address, userName, TO_CHAR(checkIn,'YYYY/MM/DD') checkIn, TO_CHAR(checkOut,'YYYY/MM/DD') checkOut
				from reservation r JOIN member m ON r.num=m.num JOIN host h ON m.num=r.num

				<where>
			     	<if test="searchValue!=null and searchValue!='' ">
			     	    <include refid="where-list"/>
			     	</if>
			     	AND (r.num=#{num})
	   		   </where>   
			ORDER BY reservationNum DESC
	<![CDATA[
			) tb WHERE ROWNUM <= #{end}
		) WHERE RNUM >= #{start}
	]]>
	</select>
	
	<!-- 글보기 -->
	<select id="readReservation" parameterType="Integer" resultType="com.pet.reservation.Reservation">
		SELECT reservationNum, TO_CHAR(checkIn,'YYYY/MM/DD') checkIn, TO_CHAR(checkOut,'YYYY/MM/DD') checkOut, pet_su, r.num, r.hostNum,
		(checkOut-checkIn) check_day, pay
		 From reservation r JOIN host h ON r.hostNum=h.hostNum
		WHERE reservationNum=#{reservationNum}
	</select>
	
	<!-- 수정 -->	
	<update id="updateReservation" parameterType="com.pet.reservation.Reservation">
		UPDATE reservation SET checkIn='#{checkIn, jdbcType=VARCHAR}', checkOut='#{checkOut, jdbcType=VARCHAR}', pet_su=#{pet_su}
		WHERE reservationNum=#{reservationNum}
	</update>
	
	<!-- 삭제 -->
	<delete id="deleteReservation" parameterType="Integer">
		DELETE FROM reservation
		WHERE reservationNum=#{reservationNum}
	</delete>		

</mapper>